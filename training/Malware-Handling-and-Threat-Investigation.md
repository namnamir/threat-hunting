# Sandbox
A Malware sandbox is a cybersecurity term referring to a specially prepared monitoring environment that mimics an end-user operating environment. Sandboxes represent an important tool in the arsenal of computer security experts and are used in conjunction with dynamic malware analysis techniques to safely observe the behavior of suspected malware in a controlled environment without risking a host machine.

Sandbox environments can be employed in a variety of configurations, depending on the needs of security researchers:
- Full system emulation: A sandbox simulating the physical hardware of the host machine, including memory and CPU.
- Emulation of operating systems: A sandbox emulating the operating system of the end user. It does not emulate the machine hardware.
- Virtualization: A virtual machine (VM)-based sandbox that contains and examines suspicious programs.

Sandboxes prevent applications from gaining access to all system resources and user data, and thus provide proactive malware detection. A sandboxing test executes or detonates code in a safe and isolated environment, where the behavior of the code and output activity can be safely observed.

In the past, sandboxes were not only used for investigation purposes but also for threat detections (honeypoting). However, sandboxing never really did deliver on its promise: to turn the unknown threats into the known ones. Therefore, the detection part is more left to new solutions like endpoint detection and response (EDR) and next-generation antivirus (NGAV). As technologies get evolved, adeversaries get smarter; they do not get easily fooled by honeypots.

[![What is Sandboxing and Why Do You Need It?](https://img.youtube.com/vi/26isu3cm_Oc/0.jpg)](https://www.youtube.com/watch?v=26isu3cm_Oc)


## Difference Between Honeypots and Snadboxes
At a high level, sandboxing involves installing and allowing malware to run for behavioral observation, while honeypots and nets focus on the analysis of threat actors conducting reconnaissance on an infiltrated network, and security deception is the more recent conception of advanced intrusion detection and prevention.

## How to Prepare a Sandbox
There are two general ways to do it; either build our own environment or use 3rd party solutions.

### How to Make Your Own Sandbox
1. Think of dedicated hardware, self-hosted virtual environment (VM), virtual servers (VPS), or cloud services.
2. Install the operationg system (OS) you need for your research.
3. Allocated enough resources (CPU/GPU, RAM, Disk) based on your OS and the purpose of the research.  
4. Setup a different network.  
  4.1. Think of adding your sandbox into DMZ, if your goal is to have internet access.  
  4.2. Isolate the newrok but do not restric it as it should mimic a normal environment.  
5. Install applications an average user (from your research population) uses.
6. Install analysis tools.  
  6.1. Debuggers  
  6.2. Traffic Analyzer  
  6.3. Process Monitoring  
  6.4. Disassemblers  
7. Turn off security tools, e.g., antivirus

[![How To Setup A Sandbox Environment For Malware Analysis](https://img.youtube.com/vi/oPsxy9JF8FM/0.jpg)](https://www.youtube.com/watch?v=oPsxy9JF8FM)

Alternatively, you can use solutions like [Cuckoo](https://cuckoosandbox.org/) that is a modular, automated malware analysis system. Running from command-line on a Linux or Mac host, it uses python and virtualization (VirtualBox, QEMU-KVM, etc) to create an isolated Windows guest environment to safely and automatically run and analyze files to collect comprehensive file behavior analysis.

### 3rd-Party Sandbox Solutions
Nowadays, the majority of 3rd-pary sandboxes are ready-made cloud-based or SaaS solutions. In this case, you do not need to prepare anything; you just bring your any research material (IoC, file, hash, etc.) and run it on the cloud-based or SaaS sandbox platform. Followings are the most famous and gratis services.

You need to use them based on the need you have. For instance, URLscan provides something that Any.Run cannot.
- [Any.Run](https://any.run/)
- [VirusTotal](https://www.virustotal.com/)
- [Joe Sandbox](https://www.joesandbox.com/)
- [Hybrid Analysis](https://Hybrid-Analysis.com)
- [URLscan](https://urlscan.io/)
- [Malwares.com](https://www.malwares.com/)
- [Jotti](https://virusscan.jotti.org/)
- [InQuest - IOC-DB](https://labs.inquest.net/iocdb)
- [CheckPhish](https://checkphish.ai/)


# Basic Scripting Techniques
A scripting language or script language is a programming language for a runtime system that automates the execution of tasks that would otherwise be performed individually by a human operator. Scripting languages are usually interpreted at runtime rather than compiled.

Here we focus on Python as a cross-platform scripting language as well as basic Bash (built-in Linux / MacOS shell) and PowerShell (built-in Windows shell).

## Git
Git is a tool to control version of codes. There are many platforms provide Git services including [GitHub](https://github.com/), [GitLab](https://about.gitlab.com/), and [Bitbucket](https://bitbucket.org/). These services, host codes as well that would be a great resource of finding useful scripts.

Here we are not going to the details, as we just like to know how to **clone** a repository to run it locally. In general there are 3 ways: either download the repository (easiest way for beginners), or after installing Git ([how?](https://github.com/git-guides/install-git)), or clone it with either SSH or HTTPS.

![How to Clone a Repository](img/Git-Clone.png)

```bash
# clone using SSH via terminal
git clone SSH_OR_HTTPS_LINK
```

[![Python for Beginners - Learn Python in 1 Hour](https://img.youtube.com/vi/CKcqniGu3tA/0.jpg)](https://www.youtube.com/watch?v=CKcqniGu3tA)

## Python
After you [install Python](https://wiki.python.org/moin/BeginnersGuide/Download), you barely need to _script_ but you mainly need to run scripts developed by others. To run scripts, use the following commands.
```bash
# if you run Python version 3
python3 SCRIPT_NAME.py

# if you run Python version 2 or Python version 3 is set to default
python3 SCRIPT_NAME.py
```

If you like to learn basic programming skills in Python, just google it to find many free videos and tutorials like [LearnPython](https://www.learnpython.org/) or the following video.

[![Python for Beginners - Learn Python in 1 Hour](https://img.youtube.com/vi/kqtD5dpn9C8/0.jpg)](https://www.youtube.com/watch?v=kqtD5dpn9C8)


# Evasion Techniques
Evasion techniques are what malicious payloads use to avoid detection from EDR, IDS/IPS, Sandboxing services, etc. Malware developers have two priorities when creating malware, being silent and being deadly, getting as much as they can for as little effort as possible. To do so, they use different techniques and tactics; it can be something low-level, high-level, or mixture of different techniques and tactics. In this section, we just focus on **malware evasion techniques**.

Defense evasion is the way to bypass detection, cover what malware is doing, and determine its activity to a specific family or authors. There are different techniques used by threat actors like injection, data encryption, and obfuscating. The tactics often induce payloads and scripts. Some of these techniques are as follows.

- Code Obfuscation and Encryption: Detection solutions can find malware's activities easily. Malware tries to hide malicious codes by obfuscation and encryption.
- Hide Artifacts: Artifacts reveal malicious activity such as files, directories, file attributes, users, etc. Malware tries to hide or isolate them to bypass detection.
- Modify Registry: Change of registry allows the malicious software to conceal data about configuration.
- Virtualization/Sandbox Evasion: Sandboxes are a real challenge for a malicious program. But it knows how to avoid a standard sandbox and recognize the virtual environment from a real one.
- Embeded Codes: Docx or PDF files seem safe but what if an attacker embeds the payload in another file and run it through them?

This video shows how a read team prepare a malware with using multiple evasion techniques and tactics.

[![Windows Defense Evasion Techniques](https://img.youtube.com/vi/5goLhInZyYQ/0.jpg)](https://www.youtube.com/watch?v=5goLhInZyYQ)

# Threat Intelligence Feeds
Threat intelligence feeds are continuous data streams filled with threat information collected by artificial intelligence. These feeds provide information on cybersecurity threats and trends in real-time, enabling organizations to proactively defend against attacks. Security teams can also use this information to better understand potential hackers' tactics, techniques, and procedures and improve their security posture accordingly.

[![Threat Intelligence Feeds](img/Threat-Intelligence-Feeds.png)]

## Types of Threat Intelligence
Cyber threat intelligence comes in the following three basic categories:

- Strategic: This type of threat intelligence offers high-level analysis for less technical audiences. It may include information about business impacts and how the threat fits into broader trends in the threat landscape. Most strategic threat intelligence comes from open sources, such as local and national media, or white papers and reports.
- Tactical: This type focuses on IoCs to enable immediate threat identification and elimination. Often considered the most basic form of threat intelligence, tactical threat intelligence is more easily generated and often automated.
- Operational: Operational threat intelligence comes from examining the details of past known attacks. By understanding the details of “who?”, “what?”, and “how?”, security teams gain insight into the motives and sophistication of threat actors.

## Indicators of Compromise (IOC) and Indicator of Attack (IOA)
An Indicator of Compromise (IOC) is often described in the forensics world as evidence on a computer that indicates that the security of the network has been breached. Investigators usually gather this data after being informed of a suspicious incident, on a scheduled basis, or after the discovery of unusual call-outs from the network. Ideally, this information is gathered to create “smarter” tools that can detect and quarantine suspicious files in the future.

Indicators of attack (IOA) focus on detecting the intent of what an attacker is trying to accomplish, regardless of the malware or exploit used in an attack. Just like AV signatures, an IOC-based detection approach cannot detect the increasing threats from malware-free intrusions and zero-day exploits. As a result, next-generation security solutions are moving to an IOA-based approach pioneered by CrowdStrike.

## Why Geopolitical Intels are Important
Cyberwarfare has become a common method of attack in geopolitical conflicts, primarily targeting government entities and critical infrastructure, such as power, utilities, banks, and communication networks. It is also important to recognize that organizations, regardless of size, must take an enhanced security stance especially considering geopolitical tensions, as cyber-attacks represent a growing and probable threat under these circumstances.

For instance, following the February 24, 2022, military invasion of Ukraine by Russia, governments and businesses around the globe are advised to be on high alert and prepared to respond to disruptive cyber activity. Experts now point out that the military invasion was preceeded by several notable cyber incidents, including deployment of wiper malware, distributed denial-of-service (DDoS) attacks on Ukrainian government websites and financial entities, and recurring defacement of multiple Ukrainian government websites. These incidents are thought to be organized and preplanned efforts that were executed with precision2. Cyberattacks have been a key tool of Russian aggression in Ukraine since before 2014, when the Kremlin annexed Crimea and hackers tried to thwart elections.

## The Most Popular Open Source Intel (OSINT)
| Source (Feed) | Description |
|:--------------|:------------|
| [Open Threat Exchange](https://otx.alienvault.com/) | List of malicious IPs, hashes, domains, URLs, and files. |
| [IBM X-Force](https://exchange.xforce.ibmcloud.com/) | List of malicious IPs, hashes, domains, URLs, files, and software names. |
| [Talos](https://www.talosintelligence.com/) | Check the reputation of IPs and domains. |
| [VirusShare](https://virusshare.com/) | List of file hashes |
| [PhishTank](https://www.phishtank.com/index.php) | List of Phishing URLs. |
| [AbuseIPDB](https://www.abuseipdb.com/) | List of IPs of hackers, spammers, and abusive activity on the internet. |
| [VirusTotal](https://www.virustotal.com/) | List of malicious IPs, hashes, domains, URLs, and files. |
| [Joe Sandbox](https://www.joesandbox.com/) | List of malicious files and URLs. |
| [URLscan](https://urlscan.io/) | List of malicious URLs. |
| [Malwares.com](https://www.malwares.com/) | List of malicious IPs, hashes, domains, and URLs. |
| [InQuest - IOC-DB](https://labs.inquest.net/iocdb) | List of malicious IPs, hashes, domains, URLs, and files. |
| [ExoneraTor](https://metrics.torproject.org/exonerator.html) | List of TOR relays. |

# Threat Investigation
While users improve their ability to detect suspicious websites, emails, and files as well as companies spend in security solutions to detect threats before reaching users, adversaries keep designing malicious files and email to deceive users.

There are ways that we can fairly assure the user reported a suspicious artifact that it is malicious or not. Probably you got the point; the user is well-trained to spot suspicious activity, report it, and get help. Our work starts from here not before it. Threat investigators investigate not hunt.

## (Shortened) Link Analysis
If we use the sandbox, it is safe to click on the link and analyze the behavior. However, sometimes, we would like to use OSINT to see what others found about it and how much malicious it is.

Before going to details, we need to understand some basics. A domain is an alphanumeric name that is pointed to an IP address. IP address is the address of the server. However, the real address might be hidden by some security services like *CloudFlare*. Additionally, an domain might have different IP addresses. Besides, URLs (links) consist of multiple elements (including domains) that each part might point to a different IP which in general means point to different servers.
[![URL Structure](img/Domain-Structure.jpg)]

By this short explanation, we need to understand what we are going to analyze: a domain name, and IP, or a URL; let's call it a suspicious artifact.

At this point, we need to talk about another concept which is redirection. Twitter changed URLs a bit as it had character limitation. It was necessary to shorten everything before posting your Tweet. Shorten URLs are kind of redirection. Look at the following structure.
```bash
https://url-you-CLICK.tld
  \_(Redirect 302) https://redirection-01.tld/page
      \_(Redirect 301) https://redirection-02.tld/page
                       .
                       .
                       .
                      \_http://url-you-SEE.tld/page
```
In this example, the user might click on `https://url-you-CLICK.tld` but ended up somewhere completely else. So, it is important to differentiate between the artifact you are going to analyze.

Anyhow, whatever artifact (URL, domain, or IP) you have, it can be checked by any OSINT tool supports the artifact you look for.

## File Analysis
Similarly, you can check files either with sandboxes or analyze them by online tools like VirusTotal. These tools usually check the hash of the file against the list they hold and maintain. Some other tools InQuest or Any.Run run the file and analyze any malicious activity. It is just a matter or time and techniques you have, e.g. reverse engineering, malware analysis.

## Email Analysis
Email is a rich-text file sent through internet from an email server to another. It can contain other files (attachments) too. Therefore, we can see an email as a webpage (HTML) that can have links, JavaScript codes, etc.

For the attachments we can easily go for the **File Analysis** strategy. Similarly, for links, the investigation strategy is provided. However, there might be malicious codes hidden in the email. There might be another threat: impersonation. For these two malicious activities, we need to do deeper investigation.

To find out more about any implemented malicious code in the email, first we need to have the email file. Downloading the email file is fairly easy but depends on the email client you use. When you have the file, the rest is analyzing the codes in the email and find out if it is malicious or not.

Checking for impersonation is not as straightforward as finding malicious codes. For that you need to analyze the header. Hopefully, there are multiple tools helping with parsing email headers (E-Mail Header Analyzer), here are some of them.

| Tool | Description |
|------|-------------|
| [MXToolbox](https://mxtoolbox.com/EmailHeaders.aspx) | Analyze the email header as well as DMARC and SPF |
| [MHA](https://mha.azurewebsites.net/) | Analyze the email header |
| [Messageheader](https://toolbox.googleapps.com/apps/messageheader/) |  |
| [Analyze my mail header](https://mailheader.org/) | Analyze the email header and the encryption |

When you know who is the original sender of the email, you can find out if there was any impersonation or not. The following image, shows how [SPF (Sender Policy Framework)](https://postmarkapp.com/guides/spf), [DKIM (DomainKeys Identified Mail)](https://postmarkapp.com/guides/dkim), and [DMARC (Domain-based Message Authentication, Reporting & Conformance)](https://postmarkapp.com/guides/dmarc) are important in email security and finding the impersonation.

[![URL Structure](img/dmarc-spf-dkim.png)]

# Documenting and Presenting Findings
One of the requirements is to document security incidents and the forensics investigations about that incident. Here are the things you need to include in your report:
- Who has reported the incident (including date)
- Affected users and assets
- What is is reported
- How the investigation performed (in details)  
- What are the (potential) impacts
- What are the recommendations to mitigate the incident

-----------
References:
- [Malware Sandbox]([https://www.spiceworks.com/it-security/cyber-risk-management/articles/what-is-sandboxing/](https://www.vmray.com/glossary/malware-sandbox/))
- [The Difference Between Sandboxing, Honeypots & Security Deception](https://www.darkreading.com/endpoint/the-difference-between-sandboxing-honeypots-security-deception)
- [Is Sandboxing Dead?](https://www.darkreading.com/vulnerabilities-threats/is-sandboxing-dead-)
- [What is an Evasion Technique?](https://www.libraesva.com/what-is-an-evasion-technique/)
- [Malware Evasion Techniques](https://www.cyberdefensemagazine.com/malware-evasion-techniques/)
- [What are Threat Intelligence Feeds?](https://securityscorecard.com/blog/what-are-threat-intelligence-feeds)
- [Preparing your organization for elevated cyber threats posed by geopolitical conflicts](https://www2.deloitte.com/content/dam/Deloitte/us/Documents/risk/us-risk-preparing-your-organization-for-elevated-cyber-threats-posed-by-geopolitical-conflicts.pdf)
- [IOA VS IOC](https://www.crowdstrike.com/cybersecurity-101/indicators-of-compromise/ioa-vs-ioc/)
